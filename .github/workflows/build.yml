# https://help.github.com/en/actions/reference/workflow-syntax-for-github-actions
name: Build environment

# name of GitHub event that triggers workflow
# https://help.github.com/en/actions/reference/events-that-trigger-workflows#watch-event-watch
on:
  # trigger when I star my own repo
  watch:
    types: [started]
  # trigger via webhook
  # https://github.com/adamrushuk/aks-nexus-velero/blob/master/TriggerCustomAction.ps1#L28
  repository_dispatch:
    types: [build]

# global environment variables
# https://help.github.com/en/actions/configuring-and-managing-workflows/using-environment-variables
env:
  # prefix: used for some globally unique name requirements
  PREFIX: rush

  # debug
  CI_DEBUG: true

  # api
  API_KEY: ${{ secrets.API_KEY }}
  API_SECRET: ${{ secrets.API_SECRET }}

  # azure creds
  ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
  ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}

  # other
  # prod or staging
  CERT_API_ENVIRONMENT: prod
  DNS_DOMAIN_NAME: nexus.thehypepipe.co.uk
  DOCKER_FQDN: docker-nexus.thehypepipe.co.uk
  DEMO_USER_USERNAME: demo_user
  # DEMO_USER_PASSWORD: ${{ secrets.DEMO_USER_PASSWORD }}
  EMAIL_ADDRESS: certadmin@domain.com
  ENABLE_TLS_INGRESS: true
  FORCE_TEST_FAIL: false
  HAS_SUBDOMAIN: true
  LOCATION: uksouth
  # NEXUS_ADMIN_PASSWORD: ${{ secrets.NEXUS_ADMIN_PASSWORD }}
  # STORAGE_KEY: 'env var set by Get-StorageKey.ps1'

  # terraform
  TF_IN_AUTOMATION: "true"
  TF_INPUT: "false"
  TF_PLAN: "tfplan"
  TF_VERSION: "0.12.24" # "latest" is supported
  TF_WORKING_DIR: ./terraform

  # Env var concatenation is currently not supported at Workflow or Job scope. See workaround below:
  # https://github.community/t5/GitHub-Actions/How-can-we-concatenate-multiple-env-vars-at-workflow-and-job/td-p/48489

jobs:
  build-and-deploy:

    # always pin versions
    # view installed software: https://help.github.com/en/actions/reference/software-installed-on-github-hosted-runners
    runs-on: ubuntu-18.04

    # only run if owner triggered action
    if: github.actor == github.event.repository.owner.login

    steps:

    # Checkout
    # https://github.com/marketplace/actions/checkout
    - uses: actions/checkout@v2
      # specify different branch
      # NOT required as I've changed the default branch to develop
      # with:
      #   ref: develop

    # Init tasks - inc Env var concatenation
    # https://github.community/t5/GitHub-Actions/How-can-we-concatenate-multiple-env-vars-at-workflow-and-job/td-p/48489
    - name: Init tasks - inc Env var concatenation (Workaround)
      run: |
        chmod -R +x ./scripts/
        echo ::set-env name=AKS_RG_NAME::${{ env.PREFIX }}-rg-aks-dev-001
        echo ::set-env name=AKS_CLUSTER_NAME::${{ env.PREFIX }}-aks-001
        echo ::set-env name=TERRAFORM_STORAGE_ACCOUNT::${{ env.PREFIX }}sttfstate${{ env.LOCATION }}001
        echo ::set-env name=TERRAFORM_STORAGE_RG::${{ env.PREFIX }}-rg-tfstate-dev-001
        echo ::set-env name=VELERO_STORAGE_RG::${{ env.PREFIX }}-rg-velero-dev-001
        echo ::set-env name=VELERO_STORAGE_ACCOUNT::${{ env.PREFIX }}stbckuksouth001

    # Show event info
    - name: Show triggered event data
      run: pwsh -command "./scripts/Get-EventData.ps1"
      env:
        GITHUB_CONTEXT: ${{ toJson(github) }}

    # Login
    - name: Login to Azure
      run: ./scripts/azure_login.sh


    # Prereqs
    - name: Create Storage Account for Terraform state
      run: ./scripts/storage_create.sh

    - name: Lookup Storage Key
      run: ./scripts/storage_key.sh

    - name: Replace tokens in Terraform config files
      run: pwsh -command "./scripts/Replace-Tokens.ps1"


    # Terraform
    - uses: hashicorp/setup-terraform@v1
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - run: |
        terraform init
        terraform validate
      working-directory: ${{ env.TF_WORKING_DIR }}

    - id: plan
      run: terraform plan -out=${{ env.TF_PLAN }}
      working-directory: ${{ env.TF_WORKING_DIR }}

    # - run: echo ${{ steps.plan.outputs.stdout }}
    # - run: echo ${{ steps.plan.outputs.stderr }}
    # - run: echo ${{ steps.plan.outputs.exitcode }}

    - name: Terraform Apply
      run: ./scripts/terraform_apply.sh
      # only apply if changes are present
      # https://www.terraform.io/docs/commands/plan.html#detailed-exitcode
      # if: steps.plan.outputs.exitcode == 2
      env:
        TF_PLAN: ${{ env.TF_PLAN }}


    # Kubernetes
    - name: Deploy kubernetes manifests
      run: ./scripts/k8s_manifests_apply.sh

    - name: Wait for resources to be "Ready"
      run: ./scripts/wait.sh


    # # Ansible
    # - name: Lint Ansible Playbook
    #   uses: ansible/ansible-lint-action@6c8c141
    #   with:
    #     targets: "./ansible"

    # - name: Run Ansible playbook
    #   run: ./scripts/ansible.sh
    #   env:
    #     NEXUS_ADMIN_PASSWORD: ${{ secrets.NEXUS_ADMIN_PASSWORD }}
    #     DEMO_USER_PASSWORD: ${{ secrets.DEMO_USER_PASSWORD }}


    # # Docker
    # - name: Docker repo login
    #   uses: Azure/docker-login@v1
    #   with:
    #     login-server: ${{ env.DOCKER_FQDN }}
    #     username: ${{ env.DEMO_USER_USERNAME }}
    #     password: ${{ secrets.DEMO_USER_PASSWORD }}

    # - name: Push images to Docker repo
    #   run: ./scripts/push_docker_images.sh


    # # Pester tests
    # - name: Run Pester tests
    #   run: pwsh -command "./scripts/Start-Test.ps1"

    # - name: Archive test artifacts
    #   uses: actions/upload-artifact@v1
    #   with:
    #     name: test results
    #     path: test/pester-test-results-junit.xml
    #   if: always()

    # Notify
    - name: Notify slack
      env:
        SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
      uses: pullreminders/slack-action@v1.0.9
      with:
        # env var concatenation not supported atm, so hard-code messages
        args: '{\"channel\":\"C012ZQHT9A4\",\"text\":\"[aks-nexus-velero] Build complete\"}'
