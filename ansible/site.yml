# configure Nexus via rest api
#
# cd ansible
# ansible-playbook site.yml --extra-vars "api_base_uri=https://nexus.thehypepipe.co.uk"
#
# set env vars
# export NEW_ADMIN_PASSWORD=<NEW_ADMIN_PASSWORD>
# export AUTOGENERATED_ADMIN_PASSWORD=<MY_AUTOGENERATED_ADMIN_PASSWORD>
---
- name: Configure Nexus
  hosts: localhost
  connection: local
  gather_facts: no
  # debugger: always

  vars:
    # assign password via environment variable
    admin_password: "{{ lookup('env', 'NEW_ADMIN_PASSWORD') }}"
    ansible_python_interpreter: /usr/bin/python3
    api_base_uri: ""
    api_url: "{{ api_base_uri }}/service/rest"
    api_user: "admin"
    autogenerated_admin_password: "{{ lookup('env', 'AUTOGENERATED_ADMIN_PASSWORD') }}"
    demo_user_username: "{{ lookup('env', 'DEMO_USER_USERNAME') }}"
    demo_user_password: "{{ lookup('env', 'DEMO_USER_PASSWORD') }}"
    enable_debug_output: "{{ lookup('env', 'CI_DEBUG') }}"

    active_realms: [
      "NexusAuthenticatingRealm",
      "NexusAuthorizingRealm",
      "DockerToken",
      "NuGetApiKey"
    ]

  # DEFAULTS
  # reduce calling the same module repeatedly with the same arguments
  # https://docs.ansible.com/ansible/latest/user_guide/playbooks_module_defaults.html
  module_defaults:
    uri:
      # automatically formats body as json, and sets the Content-Type header
      body_format: json
      user: "{{ api_user }}"
      password: "{{ admin_password }}"
      force_basic_auth: yes
      timeout: 10

  tasks:

  # INIT
  # use "import_" for static mode
  # https://docs.ansible.com/ansible/latest/user_guide/playbooks_reuse.html#dynamic-vs-static
  - name: run init tasks
    import_tasks: init_tasks.yml

  # ROLES
  - import_role:
      name: user
  - import_role:
      name: docker_repo
  - import_role:
      name: helm_repo

